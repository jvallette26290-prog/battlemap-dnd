<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Battlemap D&D</title>
  <style>
    body { margin:0; background:#111; color:#eee; font-family:Arial; }
    #board {
      width:1000px;
      height:650px;
      background:url("map.jpg") center/cover no-repeat;
      position:relative;
      margin:20px auto;
      border:2px solid #333;
    }
    .token {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  position: absolute;
  cursor: grab;

  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border: 2px solid white;
  box-shadow: 0 0 6px rgba(0,0,0,0.6);

  display: flex;
  align-items: end;
  justify-content: center;

  color: white;
  font-size: 11px;
  font-weight: bold;
  text-shadow: 0 0 4px black;
  padding-bottom: 2px;
}
  .pj1 { background-color:#3498db; }  /* bleu */
  .pj2 { background-color:#2ecc71; }  /* vert */
  .pj3 { background-color:#e67e22; }  /* orange */
  .pnj1 { background-color:#e74c3c; }  /* rouge */

    /* ===== FOG OF WAR ===== */

#board {
  position: relative;
}

#fog{
  position:absolute;
  left:0;
  top:0;
  width:100%;
  height:100%;
  z-index:50;
  pointer-events:none; /* IMPORTANT */
}

#dmTools{
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1000;
  display: none;
  gap: 8px;
}

#dmTools button{
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid #333;
  background: #fff;
  cursor: pointer;
}
  </style>
</head>
<body>
  <div id="dmTools">
  <div id="roomLabel"></div>
  <button id="resetFog">RESET FOG</button>
</div>
<div id="board">
  <div class="token pj1" data-id="pj1" style="left:100px; top:100px;background-image:url('pj1.png');">
       ODRAN </div>
  <div class="token pj2" data-id="pj2" style="left:200px; top:150px;background-image:url('pj2.png');">
       BARADUR </div>
  <div class="token pj3" data-id="pj3" style="left:260px; top:220px;background-image:url('pj3.png');">
       WEREN </div>
  <div class="token pnj" data-id="pnj1" style="left:400px; top:300px;background-image:url('pnj1.png');">
       FANATICS </div>
  
  <canvas id="fog"></canvas>
</div>

<!-- ðŸ”¥ Firebase temps rÃ©el -->
  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== QUI EST MJ ? =====
const params = new URLSearchParams(window.location.search);
const IS_MJ = params.get("dm") === "1";
const roomId = params.get("room") || "salle1";  

const FOG_SCALE = 0.25;
  
  const firebaseConfig = {
    apiKey: "AIzaSyCHg35Sghd5O4oNypF6SNVh5jFDXz2TsxU",
    authDomain: "battlemap-dnd.firebaseapp.com",
    projectId: "battlemap-dnd",
    storageBucket: "battlemap-dnd.firebasestorage.app",
    messagingSenderId: "118091329664",
    appId: "1:118091329664:web:c7072920354d41d9a77665"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const roomRef = doc(db, "rooms", roomId);

  const tokensRef = doc(db, "rooms", roomId, "sync", "tokens");
  const fogRef    = doc(db, "rooms", roomId, "sync", "fog");
  
  const board = document.getElementById("board");
  const tokens = [...document.querySelectorAll(".token")];
  
  const fog = document.getElementById("fog");
// Par dÃ©faut : le fog ne bloque pas la souris (donc tokens OK)
fog.style.pointerEvents = "none";

  /* ===== AFFICHAGE DE LA SALLE ===== */
  const roomLabel = document.getElementById("roomLabel");
if (roomLabel) {
  roomLabel.textContent = "Salle : " + roomId;
}

// MJ : on active le clic sur le fog seulement quand on maintient SHIFT
if (IS_MJ) {

  document.addEventListener("keydown", (e) => {
    if (e.key === "Shift") {
      fog.style.pointerEvents = "auto";
      fog.style.cursor = "crosshair";
    }
  });

  document.addEventListener("keyup", (e) => {
    if (e.key === "Shift") {
      fog.style.pointerEvents = "none";
      fog.style.cursor = "default";
    }
  });

}
const ctx = fog.getContext("2d");
  
// ===== OUTILS MJ : AFFICHAGE + RESET FOG =====
const dmTools = document.getElementById("dmTools");
const resetBtn = document.getElementById("resetFog");

// Afficher les outils seulement pour le MJ
if (IS_MJ && dmTools) dmTools.style.display = "flex";

// Remettre le fog entiÃ¨rement noir
function resetFog() {
  ctx.globalCompositeOperation = "source-over";
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, fog.width, fog.height);
}

// Clic sur RESET
if (resetBtn) {
resetBtn.addEventListener("click", async () => {
  if (!IS_MJ) return;
  resetFog();       // remet noir
  await saveFog();  // âœ… envoie Ã  Firestore => joueurs voient en direct
});
}

function resizeFog(){
  fog.width = Math.round(board.offsetWidth * FOG_SCALE);
  fog.height = Math.round(board.offsetHeight * FOG_SCALE);

  ctx.globalCompositeOperation = "source-over";
ctx.fillStyle = "black";
ctx.fillRect(0, 0, fog.width, fog.height);
}
resizeFog();
window.addEventListener("resize", resizeFog);

// Effacer le fog Ã  la souris (MJ)
let erasing = false;

fog.addEventListener("mousedown", e => {
  if (!IS_MJ) return;   // â›” joueur bloquÃ©
   if (!e.shiftKey) return;   // âœ… seulement si Shift
  erasing = true;
  erase(e);
});

fog.addEventListener("mousemove", e => {
  if (!IS_MJ) return;   // â›” joueur bloquÃ©
  if (!e.shiftKey) return;   // âœ… seulement si Shift
  if (erasing) erase(e);
});
  
document.addEventListener("mouseup", async () => {
  if (!erasing) return;
  erasing = false;
  await saveFog();
});

function erase(e){
  const rect = fog.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  ctx.globalCompositeOperation = "destination-out";
  ctx.beginPath();
  ctx.arc(x, y, 60, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalCompositeOperation = "source-over";
}
  
  let active = null;
  let activeTokenId = null;
  let dx = 0, dy = 0;

  function readPositions() {
    const pos = {};
    tokens.forEach(t => {
      pos[t.dataset.id] = {
        left: parseInt(t.style.left || "0", 10),
        top: parseInt(t.style.top || "0", 10)
      };
    });
    return pos;
  }

  async function savePositions() {
    await setDoc(tokenRef, { tokens: readPositions() }, { merge: true });
  }

  onSnapshot(tokensRef, (snap) => {
  const data = snap.data();
  if (!data || !data.positions) return;

  tokens.forEach(t => {
    const id = t.dataset.id;
    if (!data.positions[id]) return;
    if (activeTokenId === id) return;

    t.style.left = data.positions[id].left + "px";
    t.style.top  = data.positions[id].top  + "px";
  });
});

  tokens.forEach(t => {
    t.onmousedown = e => {
      active = t;
      activeTokenId = t.dataset.id;
      dx = e.offsetX;
      dy = e.offsetY;
    };
  });

  document.onmousemove = e => {
    if (!active) return;
    active.style.left = (e.pageX - dx - board.offsetLeft) + "px";
    active.style.top  = (e.pageY - dy - board.offsetTop) + "px";
  };

  document.onmouseup = async () => {
    if (!active) return;
    active = null;
    activeTokenId = null;
    await savePositions();
  };

 // savePositions(); // dÃ©sactivÃ© pour ne pas Ã©craser au chargement

  // ===== LOAD FOG =====
onSnapshot(fogRef, (snap) => {
  const data = snap.data();
  if (!data || !data.image) return;

  const img = new Image();
  img.onload = () => {
    ctx.globalCompositeOperation = "source-over";
    ctx.clearRect(0, 0, fog.width, fog.height);
    ctx.drawImage(img, 0, 0, fog.width, fog.height);
  };
  img.src = data.image;
});
  
  // ===== SAVE FOG =====
async function saveFog(){
  if (!IS_MJ) return;

  const dataURL = fog.toDataURL("image/png");
  await setDoc(fogRef, { fog: dataURL }, { merge: true });
}

</script>

</body>
</html>
